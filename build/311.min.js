angular.module("App.Directives", []).directive("map", [ "$window", function($window) {
    return {
        restrict: "E",
        scope: {
            complaintsData: "="
        },
        link: function($scope, $elem, ctrl) {
            var map, initialLocation = new google.maps.LatLng(47.6101, -122.342);
            navigator.geolocation && navigator.geolocation.getCurrentPosition(function(position) {
                initialLocation = new google.maps.LatLng(position.coords.latitude, position.coords.longitude), 
                map.setCenter(initialLocation);
            });
            var mapOptions = {
                zoom: 15,
                center: initialLocation
            }, markers = [];
            map = new google.maps.Map(document.getElementById("map-canvas"), mapOptions), $scope.$watch(function() {
                return $scope.complaintsData;
            }, function() {
                function addComplaintMarker(complaint) {
                    var myLatlng = new google.maps.LatLng(complaint.lat, complaint.lon), marker = new google.maps.Marker({
                        position: myLatlng,
                        map: map,
                        title: "Click to zoom"
                    });
                    markers.push(marker);
                }
                for (var i = 0; i < markers.length; i++) markers[i].setMap(null);
                if ($scope.complaintsData) for (var i = 0; i < $scope.complaintsData.length; i++) addComplaintMarker($scope.complaintsData[i]);
            });
        },
        templateUrl: "/templates/map.html"
    };
} ]), !function() {
    angular.module("App.Complaints", []), // Todo - dependency ordering...
    angular.module("App.Directives");
    angular.module("App", [ "ngRoute", "App.Directives", "App.Complaints" ]);
}(), function() {
    var ComplaintFactory = function() {
        var Complaint = function() {
            return this.id = 1, function(data) {
                // Todo - get data parsing right:
                this.unique_key = data["Unique.Key"], this.created_date = data["Unique.Key"], this.closed_date = data["Closed.Date"], 
                this.agency = data.Agency, this.agency_name = data["Agency.Name"], this.complaint_type = data["Complaint.Type"], 
                this.descriptor = data.Descriptor, this.status = data.Status, this.due_date = data["Due.Date"], 
                this.resolution_description = data["Resolution.Description"], this.address_type = data["Address.Type"], 
                this.city = data.City, this.landmark = data.Landmark, this.facility_type = data["Facility.Type"], 
                // Location
                this.borough = data.Borough, this.x_coord = data["X.Coordinate..State.plane"], this.y_coord = data["Y.Coordinate..State.plane"], 
                this.lat = data.latitude, this.lon = data.longitude, this.location_type = data["Location.Type"], 
                this.incident_zip = data["Incident.Zip"], this.incident_address = data["Incident.Address"], 
                this.street_name = data["Street.Name"];
            };
        }();
        return Complaint;
    };
    angular.module("App").factory("ComplaintModel", [ ComplaintFactory ]);
}(), !function() {
    angular.module("App.Complaints").config([ "$routeProvider", function($routeProvider) {
        $routeProvider.when("/complaints", {
            templateUrl: "templates/complaints_template.html",
            controller: "complaintsController",
            controllerAs: "ctrl"
        }).otherwise({
            redirectTo: "/complaints"
        });
    } ]);
}(), function() {
    var ComplaintsController = function(complaintsService) {
        function _init() {
            complaintsService.getComplaints().then(function(complaints) {
                ctrl.complaintsData = complaints;
            }), $("#submit").on("click", function() {
                var startDate = $("#start-date").val(), endDate = $("#end-date").val();
                console.log(startDate, endDate), complaintsService.getComplaints(startDate, endDate).then(function(complaints) {
                    console.log("returned complaints: ", complaints), ctrl.complaintsData = complaints;
                });
            });
        }
        var ctrl = this;
        _init();
    };
    angular.module("App").controller("complaintsController", [ "complaintsService", ComplaintsController ]);
}(), function() {
    var ComplaintsService = function($q, $http, ComplaintModel) {
        function getComplaints(startDate, endDate) {
            deferred = $q.defer();
            var req = {
                url: "/complaints",
                params: {
                    start: startDate,
                    end: endDate
                }
            };
            return $http(req).then(function(resp) {
                complaintsDat = resp.data.rows;
                for (var complaints = [], i = 1; i < complaintsDat.length; i++) complaints.push(new ComplaintModel(complaintsDat[i]));
                deferred.resolve(complaints);
            }), deferred.promise;
        }
        return {
            getComplaints: getComplaints
        };
    };
    angular.module("App").service("complaintsService", [ "$q", "$http", "ComplaintModel", ComplaintsService ]);
}();